<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Widget Test Page</title>
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-card: #0f3460;
            --accent: #e94560;
            --accent-hover: #ff6b6b;
            --text-primary: #ffffff;
            --text-secondary: #a0a0a0;
            --success: #00d26a;
            --warning: #ffc107;
            --error: #ff4757;
            --border: #2a2a4a;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border);
        }

        header h1 {
            font-size: 24px;
            margin-bottom: 8px;
        }

        header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 700px) {
            .grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 16px;
            border: 1px solid var(--border);
        }

        .card h2 {
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card h2 .icon {
            font-size: 16px;
        }

        .status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-badge.valid {
            background: rgba(0, 210, 106, 0.15);
            color: var(--success);
        }

        .status-badge.invalid {
            background: rgba(255, 71, 87, 0.15);
            color: var(--error);
        }

        .status-badge.warning {
            background: rgba(255, 193, 7, 0.15);
            color: var(--warning);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: currentColor;
        }

        .info-grid {
            display: grid;
            gap: 8px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            background: var(--bg-card);
            border-radius: 8px;
            font-size: 13px;
        }

        .info-row .label {
            color: var(--text-secondary);
        }

        .info-row .value {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
            color: var(--accent);
        }

        .screen-display {
            font-size: 28px;
            font-weight: 700;
            color: var(--accent);
            text-align: center;
            padding: 20px;
            background: var(--bg-card);
            border-radius: 8px;
        }

        .actions-grid {
            display: grid;
            gap: 12px;
        }

        .action-group {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
        }

        .action-group label {
            display: block;
            font-size: 12px;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .action-group textarea {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 8px;
            resize: vertical;
        }

        .action-group textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            width: 100%;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            border-color: var(--accent);
        }

        .events-log {
            height: 300px;
            overflow-y: auto;
            background: var(--bg-card);
            border-radius: 8px;
            padding: 12px;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 12px;
        }

        .event-item {
            padding: 8px 10px;
            margin-bottom: 6px;
            border-radius: 6px;
            background: var(--bg-secondary);
            border-left: 3px solid var(--accent);
        }

        .event-item.outgoing {
            border-left-color: var(--success);
        }

        .event-item .event-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 4px;
        }

        .event-item .event-type {
            font-weight: 600;
            color: var(--accent);
        }

        .event-item.outgoing .event-type {
            color: var(--success);
        }

        .event-item .event-time {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .event-item .event-payload {
            color: var(--text-secondary);
            word-break: break-all;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .token-raw {
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 11px;
            word-break: break-all;
            color: var(--text-secondary);
            background: var(--bg-card);
            padding: 10px;
            border-radius: 6px;
            max-height: 80px;
            overflow-y: auto;
        }

        .clear-btn {
            font-size: 12px;
            padding: 4px 8px;
            margin-left: auto;
        }
    </style>
</head>

<body>
    <div class="container">
        <header>
            <h1>Widget Test Page</h1>
            <p>Test bidirectional iframe communication</p>
        </header>

        <div class="grid">
            <div class="card">
                <h2><span class="icon">üîê</span> Token Status</h2>
                <div id="token-status">
                    <div class="empty-state">No token found in URL</div>
                </div>
            </div>

            <div class="card">
                <h2><span class="icon">üìç</span> Current Screen</h2>
                <div id="screen-info">
                    <div class="screen-display">-</div>
                </div>
            </div>
        </div>

        <div class="card" style="margin-bottom: 16px;">
            <h2><span class="icon">‚ö°</span> Actions</h2>
            <div class="actions-grid">
                <div class="action-group">
                    <label>Fill Input</label>
                    <textarea id="fill-input-text" rows="2" placeholder="Enter text to fill in the input..."></textarea>
                    <button class="btn btn-primary" onclick="sendFillInput()">Fill Input</button>
                </div>
                <div class="action-group">
                    <label>Send Message</label>
                    <textarea id="send-message-text" rows="2" placeholder="Enter message to send..."></textarea>
                    <button class="btn btn-primary" onclick="sendChatMessage()">Send Message</button>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>
                <span class="icon">üìã</span> Events Log
                <button class="btn btn-secondary clear-btn" onclick="clearEvents()">Clear</button>
            </h2>
            <div class="events-log" id="events-log">
                <div class="empty-state" id="empty-events">Waiting for events...</div>
            </div>
        </div>
    </div>

    <script>
        const MESSAGE_TYPES = {
            EVENT: 'BM_WIDGET_EVENT',
            ACTION: 'BM_WIDGET_ACTION',
            ACTION_RESPONSE: 'BM_WIDGET_ACTION_RESPONSE',
        };

        let widgetId = null;
        let currentScreen = null;

        function getTokenFromUrl() {
            const hash = window.location.hash;
            if (!hash) return null;
            const params = new URLSearchParams(hash.substring(1));
            return params.get('token');
        }

        function decodeJWT(token) {
            try {
                const parts = token.split('.');
                if (parts.length !== 3) throw new Error('Invalid JWT format');
                const payload = parts[1];
                const decoded = atob(payload.replace(/-/g, '+').replace(/_/g, '/'));
                return JSON.parse(decoded);
            } catch (e) {
                console.error('Failed to decode JWT:', e);
                return null;
            }
        }

        function isTokenExpired(payload) {
            if (!payload || !payload.exp) return true;
            return Date.now() >= payload.exp * 1000;
        }

        function formatDate(timestamp) {
            if (!timestamp) return '-';
            return new Date(timestamp * 1000).toLocaleString();
        }

        function initializeToken() {
            const token = getTokenFromUrl();
            const statusEl = document.getElementById('token-status');

            if (!token) {
                statusEl.innerHTML = `
                    <div class="status-badge warning"><span class="status-dot"></span>No Token</div>
                    <p style="margin-top: 12px; font-size: 13px; color: var(--text-secondary);">
                        Load this page inside an iframe with a token in the URL hash.
                        <br><br>Example: <code style="color: var(--accent);">#token=eyJ...</code>
                    </p>
                `;
                return;
            }

            const payload = decodeJWT(token);
            console.log('Decoded token', { token })

            if (!payload) {
                statusEl.innerHTML = `
                    <div class="status-badge invalid"><span class="status-dot"></span>Invalid Token</div>
                    <div class="token-raw" style="margin-top: 12px;">${token}</div>
                `;
                return;
            }

            const expired = isTokenExpired(payload);
            widgetId = payload.widgetId || payload.sub || 'unknown';
            currentScreen = payload.screen || null;

            statusEl.innerHTML = `
                <div class="status-badge ${expired ? 'invalid' : 'valid'}">
                    <span class="status-dot"></span>${expired ? 'Expired' : 'Valid'}
                </div>
                <div class="info-grid" style="margin-top: 12px;">
                    <div class="info-row">
                        <span class="label">Widget ID</span>
                        <span class="value">${widgetId}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Business ID</span>
                        <span class="value">${payload.businessId || payload.bid || '-'}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Issued At</span>
                        <span class="value">${formatDate(payload.iat)}</span>
                    </div>
                    <div class="info-row">
                        <span class="label">Expires</span>
                        <span class="value">${formatDate(payload.exp)}</span>
                    </div>
                </div>
                <details style="margin-top: 12px;">
                    <summary style="cursor: pointer; color: var(--text-secondary); font-size: 12px;">Raw Token</summary>
                    <div class="token-raw" style="margin-top: 8px;">${token}</div>
                </details>
            `;

            updateScreenDisplay();
        }

        function updateScreenDisplay() {
            document.getElementById('screen-info').innerHTML = `
                <div class="screen-display">${currentScreen || 'Unknown'}</div>
            `;
        }

        function addEventToLog(type, data, isOutgoing = false) {
            const logEl = document.getElementById('events-log');
            const emptyEl = document.getElementById('empty-events');
            if (emptyEl) emptyEl.remove();

            const time = new Date().toLocaleTimeString();
            const eventEl = document.createElement('div');
            eventEl.className = `event-item ${isOutgoing ? 'outgoing' : ''}`;
            eventEl.innerHTML = `
                <div class="event-header">
                    <span class="event-type">${isOutgoing ? '‚Üë ' : '‚Üì '}${type}</span>
                    <span class="event-time">${time}</span>
                </div>
                <div class="event-payload">${JSON.stringify(data, null, 2)}</div>
            `;
            logEl.insertBefore(eventEl, logEl.firstChild);
        }

        function clearEvents() {
            document.getElementById('events-log').innerHTML =
                '<div class="empty-state" id="empty-events">Waiting for events...</div>';
        }

        function handleIncomingMessage(event) {
            if (!event.data || !event.data.messageType) return;
            const { messageType, ...rest } = event.data;

            if (messageType === MESSAGE_TYPES.EVENT) {
                addEventToLog(rest.event || messageType, rest);
                if (rest.screen && rest.screen !== currentScreen) {
                    currentScreen = rest.screen;
                    updateScreenDisplay();
                }
            }

            if (messageType === MESSAGE_TYPES.ACTION_RESPONSE) {
                addEventToLog('ACTION_RESPONSE', rest);
            }
        }

        function generateRequestId() {
            return 'req_' + Math.random().toString(36).substring(2, 11);
        }

        function sendAction(action, payload) {
            const message = {
                messageType: MESSAGE_TYPES.ACTION,
                widgetId: widgetId || 'test-widget',
                action: action,
                screen: currentScreen || 'CHATS',
                payload: payload,
                requestId: generateRequestId(),
            };

            if (window.parent !== window) {
                window.parent.postMessage(message, '*');
                addEventToLog(action, message, true);
            } else {
                addEventToLog('ERROR', { message: 'Not running in an iframe' }, true);
            }
        }

        function sendFillInput() {
            const text = document.getElementById('fill-input-text').value;
            if (!text.trim()) { alert('Please enter some text'); return; }
            sendAction('fillInput', { text: text });
        }

        function sendChatMessage() {
            const text = document.getElementById('send-message-text').value;
            if (!text.trim()) { alert('Please enter a message'); return; }
            sendAction('sendMessage', { text: text });
            document.getElementById('send-message-text').value = '';
        }

        window.addEventListener('message', handleIncomingMessage);

        document.addEventListener('DOMContentLoaded', () => {
            initializeToken();
            addEventToLog('READY', { widgetId, screen: currentScreen, timestamp: new Date().toISOString() }, true);
        });

        document.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                if (e.target.id === 'fill-input-text') { e.preventDefault(); sendFillInput(); }
                else if (e.target.id === 'send-message-text') { e.preventDefault(); sendChatMessage(); }
            }
        });
    </script>
</body>

</html>